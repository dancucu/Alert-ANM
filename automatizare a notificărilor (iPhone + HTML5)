alias: Notificare Meteo DetaliatÄƒ ANM (iPhone + HTML5)
description: Trimite Intervalul È™i Fenomenele corectÃ¢nd diacriticele.
triggers:
  - trigger: state
    entity_id: sensor.mesaj_meteo_galati
conditions:
  - condition: state
    entity_id: sensor.mesaj_meteo_galati
    state: alerta
  - condition: template
    value_template: |-
      {% if trigger.from_state is not none %}
        {% set old_msg = trigger.from_state.attributes.mesaj_complet | default('') %}
        {% set new_msg = trigger.to_state.attributes.mesaj_complet | default('') %}
        {{ trigger.from_state.state != 'alerta' or old_msg != new_msg }}
      {% else %} true {% endif %}
actions:
  - action: notify.mobile_app_iphone_16_pro
    data:
      title: >-
        {% set text = state_attr('sensor.mesaj_meteo_galati', 'mesaj_complet') | lower | default('') %}
        {% if 'rosu' in text or 'roÈ™u' in text %} ðŸš¨ COD ROÈ˜U GALAÈšI
        {% elif 'portocaliu' in text %} ðŸŸ  COD PORTOCALIU GALAÈšI
        {% elif 'galben' in text %} âš ï¸ COD GALBEN GALAÈšI
        {% else %} â„¹ï¸ Informare Meteo GalaÈ›i {% endif %}
      message: >-
        {% set raw_text = state_attr('sensor.mesaj_meteo_galati', 'mesaj_complet') | default('') %}
        {% set text = raw_text | replace('&icirc;', 'Ã®') | replace('&Icirc;', 'ÃŽ') | replace('&acirc;', 'Ã¢') | replace('&Acirc;', 'Ã‚') | replace('&#238;', 'Ã®') %}
        {% set split_interval = text.split('Interval de valabilitate:') %}
        {% set interval = split_interval[1].split('Fenomene')[0] | trim if split_interval | length > 1 else "Vezi aplicaÈ›ia" %}
        {% set split_fenomene = text.split('Fenomene') %}
        {% if split_fenomene | length > 1 %}
          {% set raw_fen = split_fenomene[1].split('Zone')[0] | replace('vizate:', '') | replace('È™i zone vizate:', '') | trim %}
          {% set lista = raw_fen.split(',') %}
          {% set ns = namespace(out='') %}
          {% for item in lista %}{% set ns.out = ns.out + '\n- ' + item | trim %}{% endfor %}
          {% set fenomene_final = ns.out %}
        {% else %} {% set fenomene_final = " Vezi aplicaÈ›ia" %} {% endif %}
        ðŸ•’ {{ interval }}
        ðŸ’¨ Fenomene vizate:{{ fenomene_final }}
      data:
// AICI PUNEÈšI URL-UL DASBOARDULUI PE CARE VREÈšI SÄ‚-L AFIÈ˜EZE LA CLICK SAU TAP
        url: https://dashboard/
        push:
          sound:
            name: >-
              {% set text = state_attr('sensor.mesaj_meteo_galati', 'mesaj_complet') | lower | default('') %}
              {{ 'critical' if 'rosu' in text or 'roÈ™u' in text or 'portocaliu' in text else 'default' }}
            volume: 1
  - action: notify.html5
    data:
      title: "Cod Meteo GalaÈ›i"
      message: "VerificÄƒ detaliile pe dashboard."
      data:
        tag: alerta-meteo-galati
	// AICI PUNEÈšI URL-UL DASBOARDULUI PE CARE VREÈšI SÄ‚-L AFIÈ˜EZE LA CLICK SAU TAP
        url: https://dashboard/
